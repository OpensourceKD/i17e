(self.webpackChunkshell=self.webpackChunkshell||[]).push([[353],{353:(V,b,v)=>{v.r(b),v.d(b,{API_CONFIG:()=>S,CoreServicesComponent:()=>U,CoreServicesService:()=>I,DummyDataService:()=>C,MfeLoaderService:()=>x,ProductCategory:()=>E,RoleService:()=>j,SalesStatus:()=>p,SseControlService:()=>w,SseFromEventService:()=>N,UserProfileService:()=>F,UserRole:()=>n,authInterceptor:()=>T,hasRequiredRole:()=>A});var l=v(4304);let I=(()=>{class r{constructor(){}static{this.\u0275fac=function(t){return new(t||r)}}static{this.\u0275prov=l.\u0275\u0275defineInjectable({token:r,factory:r.\u0275fac,providedIn:"root"})}}return r})(),U=(()=>{class r{static{this.\u0275fac=function(t){return new(t||r)}}static{this.\u0275cmp=l.\u0275\u0275defineComponent({type:r,selectors:[["org-core-services"]],standalone:!0,features:[l.\u0275\u0275StandaloneFeature],decls:2,vars:0,template:function(t,o){1&t&&(l.\u0275\u0275elementStart(0,"p"),l.\u0275\u0275text(1," core-services works! "),l.\u0275\u0275elementEnd())}})}}return r})();var u=v(5883),n=function(r){return r.SUPER_ADMIN="super-admin",r.ORG_ADMIN="org-admin",r.TEAM_LEAD="team-lead",r.SALES_EXECUTIVE="sales-executive",r}(n||{});function A(r,f){const e={[n.SUPER_ADMIN]:4,[n.ORG_ADMIN]:3,[n.TEAM_LEAD]:2,[n.SALES_EXECUTIVE]:1};return e[r]>=e[f]}let j=(()=>{class r{constructor(){this.currentUserSubject=new u.BehaviorSubject(null),this.currentUser$=this.currentUserSubject.asObservable(),console.log("[RoleService] Service initialized"),this.loadInitialUser()}setUserFromProfile(e){console.log("[RoleService] Setting user from API profile:",e);const t=this.mapApiRoleToUserRole(e.roles),o={id:e.userId,name:e.name||e.email||"User",email:e.email||"",role:t};console.log("[RoleService] Mapped user with role from API:",o),this.setCurrentUser(o)}mapApiRoleToUserRole(e){return e&&0!==e.length?this.mapStringToUserRole(e[0].name):(console.warn("[RoleService] No roles found in API response, defaulting to SALES_EXECUTIVE"),n.SALES_EXECUTIVE)}setUserFromAuth(e){console.log("[RoleService] Setting user from Auth0 auth:",e);const t=this.mapUserInfoToUser(e);console.log("[RoleService] Mapped user with role:",t),this.setCurrentUser(t)}mapUserInfoToUser(e){const t=this.extractRoleFromToken(e);return{id:e.sub,name:e.name||e.email||"User",email:e.email||"",role:t}}extractRoleFromToken(e){if(e.role)return this.mapStringToUserRole(e.role);if(e.org_and_roles){const a=this.extractRoleFromOrgAndRoles(e.org_and_roles);if(a)return console.log("[RoleService] Extracted role from org_and_roles:",a),a}const o=Object.keys(e).filter(a=>a.startsWith("http://")||a.startsWith("https://")).find(a=>a.toLowerCase().includes("role"));if(o&&e[o]){const a=e[o],s=Array.isArray(a)?a[0]:a;return this.mapStringToUserRole(s)}return console.warn("[RoleService] No role found in token, falling back to email pattern"),this.determineRoleFromEmail(e.email||"")}extractRoleFromOrgAndRoles(e){if(!e||"object"!=typeof e)return null;const t=[];for(const a in e){const s=e[a];Array.isArray(s)&&s.forEach(i=>{const d=this.mapStringToUserRole(i);t.push(d)})}if(0===t.length)return null;const o=[n.SUPER_ADMIN,n.ORG_ADMIN,n.TEAM_LEAD,n.SALES_EXECUTIVE];for(const a of o)if(t.includes(a))return console.log("[RoleService] Selected highest privilege role:",a),a;return t[0]}mapStringToUserRole(e){const t=e.toLowerCase().replace(/[-_\s]/g,"");return{superadmin:n.SUPER_ADMIN,super:n.SUPER_ADMIN,admin:n.SUPER_ADMIN,orgadmin:n.ORG_ADMIN,organizationadmin:n.ORG_ADMIN,manager:n.ORG_ADMIN,teamlead:n.TEAM_LEAD,lead:n.TEAM_LEAD,salesexecutive:n.SALES_EXECUTIVE,sales:n.SALES_EXECUTIVE,executive:n.SALES_EXECUTIVE}[t]||n.SALES_EXECUTIVE}determineRoleFromEmail(e){const t=e.toLowerCase();return[{patterns:["admin","super"],role:n.SUPER_ADMIN},{patterns:["manager","org"],role:n.ORG_ADMIN},{patterns:["lead","team"],role:n.TEAM_LEAD}].find(({patterns:s})=>s.some(i=>t.includes(i)))?.role??n.SALES_EXECUTIVE}loadInitialUser(){const e=this.getDevMimicUser();if(e)return console.log("[RoleService] Using dev mimic user:",e),void this.currentUserSubject.next(e)}getDevMimicUser(){try{const e=localStorage.getItem("dev_mimic_user");if(e){const t=JSON.parse(e);if(t.id&&t.name&&t.role)return t}}catch(e){console.error("[RoleService] Error parsing dev mimic user:",e)}return null}setDevMimicUser(e){e?(localStorage.setItem("dev_mimic_user",JSON.stringify(e)),this.currentUserSubject.next(e),console.log("[RoleService] Dev mimic user set:",e)):(localStorage.removeItem("dev_mimic_user"),this.loadDummyUser(),console.log("[RoleService] Dev mimic user cleared"))}loadDummyUser(){console.log("[RoleService] Loading user from session storage");const e=sessionStorage.getItem("current_user");if(e){const t=JSON.parse(e);console.log("[RoleService] User loaded from session:",t),this.currentUserSubject.next(t)}else{const t={id:"user-1",name:"John Admin",email:"john.admin@company.com",role:n.ORG_ADMIN};console.log("[RoleService] No saved user found, using default:",t),this.setCurrentUser(t)}}setCurrentUser(e){console.log("[RoleService] Setting current user:",e),this.currentUserSubject.next(e),e?(sessionStorage.setItem("current_user",JSON.stringify(e)),console.log("[RoleService] User saved to session storage")):(sessionStorage.removeItem("current_user"),console.log("[RoleService] User removed from session storage"))}getCurrentUser(){const e=this.currentUserSubject.value;return console.log("[RoleService] getCurrentUser() called, returning:",e),e}getCurrentUserRole(){const e=this.currentUserSubject.value?.role||null;return console.log("[RoleService] getCurrentUserRole() called, returning:",e),e}hasRole(e){const t=this.getCurrentUserRole();if(!t)return console.log("[RoleService] hasRole() - No current role, access denied"),!1;const o=A(t,e);return console.log(`[RoleService] hasRole() - Checking if ${t} has ${e}:`,o),o}canViewOthersData(){const e=this.getCurrentUserRole(),t=e===n.SUPER_ADMIN||e===n.ORG_ADMIN||e===n.TEAM_LEAD;return console.log(`[RoleService] canViewOthersData() - Role: ${e}, Can view:`,t),t}getViewableUsers(){const e=this.getCurrentUser();if(!e)return[];const t=this.getAllUsers();return this.isTeamLeadOrHigher()?t.filter(o=>o.role===n.SALES_EXECUTIVE||o.id===e.id):t.filter(o=>o.id===e.id)}hasAnyRole(e){const t=this.getCurrentUser();return!!t&&e.includes(t.role)}isAdmin(){return this.hasAnyRole([n.SUPER_ADMIN,n.ORG_ADMIN])}isTeamLeadOrHigher(){return this.hasAnyRole([n.SUPER_ADMIN,n.ORG_ADMIN,n.TEAM_LEAD])}getAllUsers(){return[{id:"user-1",name:"John Admin",email:"john.admin@company.com",role:n.SUPER_ADMIN},{id:"user-2",name:"Sarah Manager",email:"sarah.manager@company.com",role:n.ORG_ADMIN},{id:"user-3",name:"Mike Lead",email:"mike.lead@company.com",role:n.TEAM_LEAD,teamId:"team-1"},{id:"user-4",name:"Alice Sales",email:"alice.sales@company.com",role:n.SALES_EXECUTIVE,teamId:"team-1",managerId:"user-3"},{id:"user-5",name:"Bob Sales",email:"bob.sales@company.com",role:n.SALES_EXECUTIVE,teamId:"team-1",managerId:"user-3"},{id:"user-6",name:"Carol Sales",email:"carol.sales@company.com",role:n.SALES_EXECUTIVE,teamId:"team-1",managerId:"user-3"}]}static{this.\u0275fac=function(t){return new(t||r)}}static{this.\u0275prov=l.\u0275\u0275defineInjectable({token:r,factory:r.\u0275fac,providedIn:"root"})}}return r})();var p=function(r){return r.COMPLETED="completed",r.PENDING="pending",r.CANCELLED="cancelled",r}(p||{}),E=function(r){return r.ELECTRONICS="Electronics",r.SOFTWARE="Software",r.SERVICES="Services",r.HARDWARE="Hardware",r}(E||{});let C=(()=>{class r{constructor(){this.salesExecutivesSubject=new u.BehaviorSubject(this.generateSalesExecutives()),this.salesExecutives$=this.salesExecutivesSubject.asObservable(),this.salesRecordsSubject=new u.BehaviorSubject(this.generateSalesRecords()),this.salesRecords$=this.salesRecordsSubject.asObservable(),this.incentiveRulesSubject=new u.BehaviorSubject(this.generateIncentiveRules()),this.incentiveRules$=this.incentiveRulesSubject.asObservable(),this.incentivesEarnedSubject=new u.BehaviorSubject(this.generateIncentivesEarned()),this.incentivesEarned$=this.incentivesEarnedSubject.asObservable(),console.log("[DummyDataService] Service initialized"),console.log("[DummyDataService] Generated data:",{salesExecutives:this.salesExecutivesSubject.value.length,salesRecords:this.salesRecordsSubject.value.length,incentiveRules:this.incentiveRulesSubject.value.length,incentivesEarned:this.incentivesEarnedSubject.value.length})}generateSalesExecutives(){return console.log("[DummyDataService] Generating sales executives"),[{id:"user-1",name:"John Admin",email:"john.admin@company.com",teamId:"team-1"},{id:"user-2",name:"Sarah Manager",email:"sarah.manager@company.com",teamId:"team-1"},{id:"user-3",name:"Mike Lead",email:"mike.lead@company.com",teamId:"team-1"},{id:"user-4",name:"Alice Sales",email:"alice.sales@company.com",teamId:"team-1"},{id:"user-5",name:"Bob Sales",email:"bob.sales@company.com",teamId:"team-1"},{id:"user-6",name:"Carol Sales",email:"carol.sales@company.com",teamId:"team-1"}]}generateSalesRecords(){console.log("[DummyDataService] Generating sales records");const e=[],t=this.generateSalesExecutives(),o=["Product A","Product B","Product C","Product D"],a=[p.COMPLETED,p.PENDING,p.CANCELLED];for(let s=0;s<50;s++){const i=t[s%t.length],d=Math.floor(s/10),m=new Date;m.setMonth(m.getMonth()-d),e.push({id:`sale-${s+1}`,salesExecutiveId:i.id,salesExecutiveName:i.name,date:m,productName:o[s%o.length],productCategory:E.SOFTWARE,amount:Math.floor(5e4*Math.random())+1e4,commission:Math.floor(5e3*Math.random()),quantity:Math.floor(10*Math.random())+1,status:a[s%a.length],clientName:`Client ${s+1}`,region:["North","South","East","West"][s%4]})}return e}generateIncentiveRules(){return console.log("[DummyDataService] Generating incentive rules"),[{id:"rule-1",name:"Basic Sales Incentive",description:"5% incentive on all sales",type:"percentage",value:5,isActive:!0,createdBy:"admin",createdAt:new Date("2024-01-01")},{id:"rule-2",name:"High Value Sales Bonus",description:"10% incentive on sales above $50,000",type:"percentage",value:10,minSalesAmount:5e4,isActive:!0,createdBy:"admin",createdAt:new Date("2024-02-01")},{id:"rule-3",name:"Product A Special",description:"Fixed $500 bonus for Product A sales",type:"fixed",value:500,productCategory:"Product A",isActive:!0,createdBy:"team-lead-1",createdAt:new Date("2024-03-01")},{id:"rule-4",name:"Tiered Volume Incentive",description:"15% incentive on sales above $100,000",type:"tiered",value:15,minSalesAmount:1e5,isActive:!1,createdBy:"admin",createdAt:new Date("2024-04-01")}]}generateIncentivesEarned(){console.log("[DummyDataService] Generating incentives earned");const e=[],t=this.generateSalesExecutives(),o=this.generateIncentiveRules(),a=["pending","approved","paid"];for(let s=0;s<30;s++){const i=t[s%t.length],d=o[s%o.length],m=Math.floor(s/10),c=new Date;c.setMonth(c.getMonth()-m),e.push({id:`incentive-${s+1}`,salesExecutiveId:i.id,salesExecutiveName:i.name,ruleId:d.id,ruleName:d.name,salesRecordId:`sale-${s+1}`,amount:Math.floor(5e3*Math.random())+500,earnedDate:c,status:a[s%3]})}return e}getSalesRecordsForExecutive(e){console.log("[DummyDataService] getSalesRecordsForExecutive() called for:",e);const t=this.salesRecordsSubject.value.filter(o=>o.salesExecutiveId===e);return console.log("[DummyDataService] Found",t.length,"sales records for executive:",e),t}getIncentivesForExecutive(e){console.log("[DummyDataService] getIncentivesForExecutive() called for:",e);const t=this.incentivesEarnedSubject.value.filter(o=>o.salesExecutiveId===e);return console.log("[DummyDataService] Found",t.length,"incentives for executive:",e),t}getReportDataForExecutive(e){console.log("[DummyDataService] getReportDataForExecutive() called for:",e);const t=this.salesExecutivesSubject.value.find(c=>c.id===e),o=this.getSalesRecordsForExecutive(e),a=this.getIncentivesForExecutive(e),s=o.filter(c=>"completed"===c.status).reduce((c,g)=>c+g.amount,0),i=a.filter(c=>"pending"!==c.status).reduce((c,g)=>c+g.amount,0),d=[];for(let c=5;c>=0;c--){const g=new Date;g.setMonth(g.getMonth()-c);const M=g.toISOString().substring(0,7),G=o.filter(h=>h.date.toISOString().substring(0,7)===M&&"completed"===h.status).reduce((h,y)=>h+y.amount,0),_=a.filter(h=>h.earnedDate.toISOString().substring(0,7)===M&&"pending"!==h.status).reduce((h,y)=>h+y.amount,0);d.push({month:M,sales:G,incentives:_})}const m={salesExecutiveId:e,salesExecutiveName:t?.name||"Unknown",totalSales:s,totalIncentives:i,period:"Last 6 months",breakdown:d};return console.log("[DummyDataService] Report data generated:",m),m}getSalesExecutives(){const e=this.salesExecutivesSubject.value;return console.log("[DummyDataService] getSalesExecutives() called, returning",e.length,"executives"),e}getIncentiveRules(){const e=this.incentiveRulesSubject.value;return console.log("[DummyDataService] getIncentiveRules() called, returning",e.length,"rules"),e}addIncentiveRule(e){console.log("[DummyDataService] addIncentiveRule() called with:",e),this.incentiveRulesSubject.next([...this.incentiveRulesSubject.value,e]),console.log("[DummyDataService] Rule added successfully, total rules:",this.incentiveRulesSubject.value.length)}updateIncentiveRule(e,t){console.log("[DummyDataService] updateIncentiveRule() called for rule:",e,"with updates:",t);const a=this.incentiveRulesSubject.value.map(s=>s.id===e?{...s,...t}:s);this.incentiveRulesSubject.next(a),console.log("[DummyDataService] Rule updated successfully")}deleteIncentiveRule(e){console.log("[DummyDataService] deleteIncentiveRule() called for rule:",e);const o=this.incentiveRulesSubject.value.filter(a=>a.id!==e);this.incentiveRulesSubject.next(o),console.log("[DummyDataService] Rule deleted successfully, remaining rules:",this.incentiveRulesSubject.value.length)}static{this.\u0275fac=function(t){return new(t||r)}}static{this.\u0275prov=l.\u0275\u0275defineInjectable({token:r,factory:r.\u0275fac,providedIn:"root"})}}return r})();var D=v(467),L=v(1913);let x=(()=>{class r{constructor(){this.mfeConfigs=[],this.loadedMfesSubject=new u.BehaviorSubject(new Set),this.loadedMfes$=this.loadedMfesSubject.asObservable(),this.loadingMfesSubject=new u.BehaviorSubject(new Set),this.loadingMfes$=this.loadingMfesSubject.asObservable(),console.log("[MfeLoaderService] Service initialized")}setConfigs(e){console.log("[MfeLoaderService] setConfigs() called with",e.length,"configurations"),this.mfeConfigs=e.sort((t,o)=>o.priority-t.priority),console.log("[MfeLoaderService] Configurations sorted by priority:",this.mfeConfigs.map(t=>({name:t.name,priority:t.priority})))}getConfigs(){return console.log("[MfeLoaderService] getConfigs() called, returning",this.mfeConfigs.length,"configurations"),this.mfeConfigs}getConfigsForRole(e){console.log("[MfeLoaderService] getConfigsForRole() called for role:",e);const t=this.mfeConfigs.filter(o=>o.allowedRoles.includes(e));return console.log("[MfeLoaderService] Found",t.length,"configurations for role:",e,t.map(o=>o.name)),t}getConfigByName(e){console.log("[MfeLoaderService] getConfigByName() called for:",e);const t=this.mfeConfigs.find(o=>o.name===e);return t?console.log("[MfeLoaderService] Found configuration for:",e):console.warn("[MfeLoaderService] Configuration not found for:",e),t}preloadPriorityMfes(e){var t=this;return(0,D.A)(function*(){console.log("[MfeLoaderService] preloadPriorityMfes() called for role:",e);const a=t.getConfigsForRole(e).filter(i=>i.priority>=5);console.log("[MfeLoaderService] Preloading",a.length,"priority MFEs:",a.map(i=>({name:i.name,priority:i.priority})));const s=a.map(i=>t.loadMfe(i));yield Promise.all(s),console.log("[MfeLoaderService] Preloading complete")})()}loadMfe(e){var t=this;return(0,D.A)(function*(){const o=t.loadingMfesSubject.value,a=t.loadedMfesSubject.value;if(a.has(e.name))console.log(`[MfeLoaderService] MFE ${e.name} already loaded`);else if(o.has(e.name))console.log(`[MfeLoaderService] MFE ${e.name} is already loading`);else try{const s=new Set(o);s.add(e.name),t.loadingMfesSubject.next(s),console.log(`[MfeLoaderService] Loading MFE ${e.name} (priority: ${e.priority})`),console.log("[MfeLoaderService] MFE config:",{name:e.name,url:e.url,exposedModule:e.exposedModule,remoteName:e.remoteName});const i=yield(0,L.loadRemoteModule)({type:"module",remoteEntry:e.url,exposedModule:e.exposedModule}),d=new Set(a);d.add(e.name),t.loadedMfesSubject.next(d);const m=new Set(t.loadingMfesSubject.value);return m.delete(e.name),t.loadingMfesSubject.next(m),console.log(`[MfeLoaderService] Successfully loaded MFE ${e.name}`),console.log("[MfeLoaderService] Currently loaded MFEs:",Array.from(t.loadedMfesSubject.value)),i}catch(s){console.error(`[MfeLoaderService] Error loading MFE ${e.name}:`,s),console.error("[MfeLoaderService] Failed config:",{name:e.name,url:e.url,exposedModule:e.exposedModule});const i=new Set(t.loadingMfesSubject.value);throw i.delete(e.name),t.loadingMfesSubject.next(i),s}})()}isMfeLoaded(e){const t=this.loadedMfesSubject.value.has(e);return console.log(`[MfeLoaderService] isMfeLoaded(${e}):`,t),t}isMfeLoading(e){const t=this.loadingMfesSubject.value.has(e);return console.log(`[MfeLoaderService] isMfeLoading(${e}):`,t),t}static{this.\u0275fac=function(t){return new(t||r)}}static{this.\u0275prov=l.\u0275\u0275defineInjectable({token:r,factory:r.\u0275fac,providedIn:"root"})}}return r})();var R=v(6883);let N=(()=>{class r{constructor(e){this.zone=e}listen(){const e=new EventSource("https://stream.wikimedia.org/v2/stream/recentchange");return(0,u.fromEvent)(e,"message").pipe((0,R.map)(t=>{let o;return this.zone.run(()=>o=t.data),o}))}static{this.\u0275fac=function(t){return new(t||r)(l.\u0275\u0275inject(l.NgZone))}}static{this.\u0275prov=l.\u0275\u0275defineInjectable({token:r,factory:r.\u0275fac,providedIn:"root"})}}return r})(),w=(()=>{class r{constructor(e){this.zone=e}start(e){this.eventSource=new EventSource(e);const t=this.eventSource;return new u.Observable(o=>{const a=(0,u.fromEvent)(t,"message").subscribe(s=>{this.zone.run(()=>o.next(s.data))});return t.onerror=s=>{this.zone.run(()=>o.error(s))},()=>{a.unsubscribe(),t.close()}})}stop(){this.eventSource&&(this.eventSource.close(),this.eventSource=void 0)}static{this.\u0275fac=function(t){return new(t||r)(l.\u0275\u0275inject(l.NgZone))}}static{this.\u0275prov=l.\u0275\u0275defineInjectable({token:r,factory:r.\u0275fac,providedIn:"root"})}}return r})();const S={baseUrl:"https://tmzuktmjy7.execute-api.us-east-1.amazonaws.com"};var P=v(8072);let F=(()=>{class r{constructor(e){this.http=e,this.profileSubject=new u.BehaviorSubject(null),this.profile$=this.profileSubject.asObservable(),console.log("[UserProfileService] Service initialized")}fetchUserProfile(){return console.log("[UserProfileService] Fetching user profile from API"),S&&S.baseUrl?this.http.get(`${S.baseUrl}/auth/me`).pipe((0,R.map)(e=>e.success&&e.data?(console.log("[UserProfileService] Profile loaded successfully"),this.profileSubject.next(e.data),e.data):null),(0,R.catchError)(e=>(console.error("[UserProfileService] Error fetching profile:",e),this.profileSubject.next(null),(0,u.of)(null)))):(console.error("[UserProfileService] API_CONFIG or baseUrl is not defined"),(0,u.of)(null))}getCurrentProfile(){return this.profileSubject.value}getPrimaryOrganization(){return this.profileSubject.value?.organizations?.[0]||null}getPrimaryRole(){return this.profileSubject.value?.roles?.[0]||null}getRoleName(){return this.getPrimaryRole()?.name||null}getOrganizationDisplayName(){return this.getPrimaryOrganization()?.displayName||null}clearProfile(){this.profileSubject.next(null)}static{this.\u0275fac=function(t){return new(t||r)(l.\u0275\u0275inject(P.HttpClient))}}static{this.\u0275prov=l.\u0275\u0275defineInjectable({token:r,factory:r.\u0275fac,providedIn:"root"})}}return r})();var O=v(7544);const T=(r,f)=>{const t=(0,l.inject)(O.AuthService).getTokenSync();return!t||$(r.url)?f(r):f(r.clone({setHeaders:{Authorization:`Bearer ${t}`}}))},$=r=>{try{if(S&&"object"==typeof S&&S.baseUrl&&r.startsWith(S.baseUrl))return!1}catch(e){console.warn("[authInterceptor] API_CONFIG not available, using pattern-based auth endpoint detection",e)}return["/oauth","auth0.com","/authorize","/token"].some(e=>r.includes(e))}}}]);